<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Productos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form div { margin-bottom: 10px; }
    label { display: inline-block; width: 100px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    button { margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Agregar Nuevo Producto</h1>
  <form id="productForm" enctype="multipart/form-data">
    <div>
      <label for="name">Nombre:</label>
      <input type="text" id="name" name="name" required>
    </div>
    <div>
      <label for="price">Precio:</label>
      <input type="number" id="price" name="price" step="0.01" required>
    </div>
    <div>
      <label for="description">Descripción:</label>
      <textarea id="description" name="description"></textarea>
    </div>
    <div>
      <label for="image">Imagen:</label>
      <input type="file" id="image" name="image" accept="image/*">
    </div>
    <button type="submit">Agregar Producto</button>
  </form>

  <h2>Lista de Productos</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Precio</th>
        <th>Descripción</th>
        <th>Imagen</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>

  <script>
    // Función para obtener productos desde el backend
    async function fetchProducts() {
      try {
        const response = await fetch('/products');
        
        if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
        
        const products = await response.json();
        const tableBody = document.getElementById('productTableBody');
        tableBody.innerHTML = ''; // Limpiar tabla antes de agregar nuevos productos
  
        products.forEach(product => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${product._id}</td>
            <td>${product.name}</td>
            <td>${product.price}</td>
            <td>${product.description}</td>
            <td><img src="/uploads/${product.image}" width="100"></td>
            <td>
              <button onclick="editProduct('${product._id}')">Editar</button>
              <button onclick="deleteProduct('${product._id}')">Eliminar</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('❌ Error al obtener productos:', error);
        alert(`❌ Error al cargar productos: ${error.message}`);
      }
    }
  
    // Manejar el formulario de agregar producto
    document.getElementById('productForm').addEventListener('submit', async function (e) {
      e.preventDefault();
  
      const name = document.getElementById('name').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const description = document.getElementById('description').value.trim();
      const imageFile = document.getElementById('image').files[0];
  
      if (!name || isNaN(price) || price <= 0 || !description) {
        alert('⚠️ Todos los campos son obligatorios y el precio debe ser un número mayor a 0.');
        return;
      }
  
      try {
        // Creamos el objeto FormData para enviar la imagen junto con otros datos
        const formData = new FormData();
        formData.append('name', name);
        formData.append('price', price);
        formData.append('description', description);
        if (imageFile) formData.append('image', imageFile);

        const response = await fetch('/products', {
          method: 'POST',
          body: formData
        });
  
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Error desconocido al agregar producto.');
        }
  
        alert('✅ Producto agregado exitosamente');
        document.getElementById('productForm').reset();
        fetchProducts();
      } catch (error) {
        console.error('❌ Error:', error);
        alert(`❌ Error al agregar producto: ${error.message}`);
      }
    });
  
    // Eliminar un producto
    async function deleteProduct(id) {
  console.log('ID del producto a eliminar:', id);  // Verificar ID antes de la solicitud

  if (confirm('⚠️ ¿Estás seguro de eliminar este producto?')) {
    try {
      const response = await fetch(`/products/${id}`, { method: 'DELETE' });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Error desconocido al eliminar producto.');
      }

      alert('✅ Producto eliminado');
      fetchProducts();
    } catch (error) {
      console.error('❌ Error:', error);
      alert(`❌ Error al eliminar producto: ${error.message}`);
    }
  }
}

    // Cargar productos cuando la página se cargue
    fetchProducts();
  </script>
</body>
</html>
